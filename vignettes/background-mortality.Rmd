---
title: "Background mortality"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Background mortality}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is the second in a series of vignettes illustrating methods for evaluating the fit and efficiency of three state oncology cost-effectiveness model structures, as described in an accompanying journal article.[1] The package is heavily dependent on [flexsurv](https://cran.r-project.org/package=flexsurv)).[2]

It is being rewritten.

### Discounting

Health economic models such as cost-effectiveness models usually evaluate quantities of interest in (net) present value terms, after applying discounting. This can be readily included in formulae above by including a discounting factor in the integrals.

Suppose a discount rate $i$\% applies over unit time. Then the discounting factor at time $t$ is $v(t;i)=(1+i)^{-t}$. Note that $v(t;i=0)=1$.

### Programming implications

The calculation of restricted mean durations in *psm3mkv* default to assume no life table constraints or discounting. However, when a lifetable is specified, then $S_{gen}(t)$ and $h_{gen}(t)$ are specified and constrain the estimated means as indicated. When a discount rate is specified, then the mean estimates reflect this also.


### Creating the life table

In order to apply constraints to background mortality, we need some background mortality data, in the form of a lifetable. We can take this from the Human Mortality Database using the *HMDHFDplus* package mentioned above (with thanks to Robert Hettle for the recommendation). The lifetable will need to start from an assumed age at baseline. Lifetables are constructed by time in years.

```{r ltable1, eval=FALSE}
# Assumed population age at baseline (time=0)
baseage <- 51.0

# Mortality data - England & Wales, Female, 2019
mort <- HMDHFDplus::readHMDweb(CNTRY="GBRTENW",
                        item="fltper_1x1",
                        username="",
                        password=""
                        ) |>
              filter(Year==2019) |>
              select(Age, lx, dx) |>
              mutate(Timey = ceiling(Age-baseage)) |>
              filter(Timey>=0)

# The table needs to end with lx=0
mort <- dplyr::add_row(mort, Age=111, lx=0, Timey=60)
```

You will see that the above code cannot run without a login for the Human Mortality Database (www.mortality.org). Alternatively, we could just make up a mortality table.

```{r ltable2}
mort <- tibble::tibble(
  Timey = 0:30,
  lx = 10000 * exp(-0.03 * Timey^1.1),
  dx = lx - dplyr::lead(lx),
  qx = dx/lx
  )
```

However we do it, once we have the mortality data, we can apply the SMR ($R$) and derive a lifetable from time zero as required.

```{r ltable3}
# Assumed Standardized Mortality Ratio
SMR <- 2

# Recalculate the lifetable with the SMR applied
mort$adjlx <- mort$lx
for (i in 2:length(mort$lx)) {
  mort$adjlx[i] <- mort$adjlx[i-1] * (1 - SMR * mort$qx[i-1])
}

# Ensure lx>=0
mort$adjlx[mort$adjlx<0] <- 0

# Create and view lifetable
ltable <- tibble::tibble(lttime=mort$Timey, lx=mort$adjlx)
head(ltable)
```

## References

1. Muston D. Informing structural assumptions for three state oncology cost-effectiveness models through model efficiency and fit. In review.

2. Jackson C, Metcalfe P, Amdahl J, Warkentin MT, Sweeting M, Kunzmann K. flexsurv: Flexible Parametric Survival and Multi-State Models. Available at: https://cran.r-project.org/package=flexsurv.

3. National Institute for Health and Care Excellence. Avalglucosidase alfa for treating Pompe disease. Technology appraisal guidance [TA821]. August 24, 2022. Available from: [https://www.nice.org.uk/guidance/ta821/documents/committee-papers](https://www.nice.org.uk/guidance/ta821/documents/committee-papers)

4. Sweeting et al. Survival Extrapolation Incorporating General Population Mortality Using Excess Hazard and Cure Models: A Tutorial. Med Decis Making 2023 Aug;43(6):737-748. [DOI: 10.1177/0272989X231184247](https://doi.org/10.1177/0272989X231184247)
